<section id="contact" class="contact w-full">
    <div class="container px-12">
        <div class="section-header">
            <h2 class="section-title">Let's Create Something Special</h2>
            <p class="section-subtitle">Ready to elevate your next event?</p>
        </div>
        <div class="contact-content">
            <div class="contact-info">
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fa-solid fa-envelope"></i>
                    </div>
                    <div class="contact-details">
                        <h3>Email</h3>
                        <p>
                            <a href="mailto:tableofthreecatering@gmail.com"
                                >tableofthreecatering@gmail.com</a
                            >
                        </p>
                    </div>
                </div>
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fa-solid fa-phone"></i>
                    </div>
                    <div class="contact-details">
                        <h3>Phone</h3>
                        <p>07787 163522</p>
                    </div>
                </div>
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fa-solid fa-location-dot"></i>
                    </div>
                    <div class="contact-details">
                        <h3>Service Area</h3>
                        <p>Belfast and surrounding areas</p>
                    </div>
                </div>
            </div>
            <div class="contact-form">
                <form class="form" id="contact-form">
                    <div
                        id="form-message"
                        class="form-message"
                        style="display: none;"
                    >
                    </div>
                    <div class="form-group">
                        <input
                            type="text"
                            id="name"
                            name="name"
                            placeholder="Your Name"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <input
                            type="email"
                            id="email"
                            name="email"
                            placeholder="Your Email"
                            required
                        />
                    </div>
                    <div class="form-group">
                        <input
                            type="tel"
                            id="phone"
                            name="phone"
                            placeholder="Your Phone"
                        />
                    </div>
                    <div class="form-group">
                        <select id="service" name="service" required>
                            <option value="">Select Service Type</option>
                            <option value="wedding">Wedding</option>
                            <option value="corporate">Corporate Event</option>
                            <option value="private">Private Dining</option>
                            <option value="special">Special Event</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input
                            type="text"
                            id="event-date"
                            name="event-date"
                            placeholder="dd/mm/yyyy"
                            pattern="^[0-9]{2}/[0-9]{2}/[0-9]{4}$"
                            title="Please enter a date in dd/mm/yyyy format (e.g., 25/12/2024)"
                            maxlength="10"
                        />
                    </div>
                    <div class="form-group">
                        <textarea
                            id="message"
                            name="message"
                            placeholder="Tell us about your event..."
                            rows="5"></textarea>
                    </div>
                    <button
                        type="submit"
                        class="btn btn-primary btn-full"
                        id="submit-btn"
                    >
                        Send Message
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById(
            "event-date",
        ) as HTMLInputElement;
        const contactForm = document.getElementById(
            "contact-form",
        ) as HTMLFormElement;
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;
        const formMessage = document.getElementById(
            "form-message",
        ) as HTMLDivElement;

        // Date input formatting
        if (dateInput) {
            // Clear validation message on input
            dateInput.addEventListener("input", (e) => {
                const target = e.target as HTMLInputElement;
                if (!target) return;

                // Clear any validation message
                target.setCustomValidity("");

                let value = target.value.replace(/\D/g, ""); // Remove all non-digits

                // Add slashes automatically
                if (value.length >= 2) {
                    value = value.substring(0, 2) + "/" + value.substring(2);
                }
                if (value.length >= 5) {
                    value = value.substring(0, 5) + "/" + value.substring(5, 9);
                }

                target.value = value;
            });

            // Validate on blur only if field has a value
            dateInput.addEventListener("blur", (e) => {
                const target = e.target as HTMLInputElement;
                if (!target) return;

                const value = target.value.trim();
                const pattern = /^[0-9]{2}\/[0-9]{2}\/[0-9]{4}$/;

                // Only validate if field has a value
                if (value && !pattern.test(value)) {
                    target.setCustomValidity(
                        "Please enter a valid date in dd/mm/yyyy format (e.g., 25/12/2024)",
                    );
                } else {
                    target.setCustomValidity("");
                }
            });

            // Prevent invalid characters on keydown
            dateInput.addEventListener("keydown", (e) => {
                // Allow: backspace, delete, tab, escape, enter, and arrow keys
                if (
                    [8, 9, 27, 13, 46, 37, 38, 39, 40].indexOf(e.keyCode) !==
                        -1 ||
                    // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true)
                ) {
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if (
                    (e.shiftKey || e.keyCode < 48 || e.keyCode > 57) &&
                    (e.keyCode < 96 || e.keyCode > 105)
                ) {
                    e.preventDefault();
                }
            });
        }

        // Form submission
        if (contactForm) {
            contactForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                // Hide previous messages
                formMessage.style.display = "none";
                formMessage.className = "form-message";

                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.textContent = "Sending...";

                try {
                    const formData = new FormData(contactForm);
                    const data = {
                        name: formData.get("name"),
                        email: formData.get("email"),
                        phone: formData.get("phone"),
                        service: formData.get("service"),
                        "event-date": formData.get("event-date"),
                        message: formData.get("message"),
                    };

                    const response = await fetch("/api/contact", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Success message
                        formMessage.textContent =
                            "Thank you! Your message has been sent successfully.";
                        formMessage.className =
                            "form-message form-message-success";
                        formMessage.style.display = "block";
                        contactForm.reset();
                    } else {
                        // Error message
                        formMessage.textContent =
                            result.error ||
                            "Failed to send message. Please try again.";
                        formMessage.className =
                            "form-message form-message-error";
                        formMessage.style.display = "block";
                    }
                } catch (error) {
                    // Network or other error
                    formMessage.textContent =
                        "An error occurred. Please try again later.";
                    formMessage.className = "form-message form-message-error";
                    formMessage.style.display = "block";
                } finally {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Send Message";
                }
            });
        }
    });
</script>
